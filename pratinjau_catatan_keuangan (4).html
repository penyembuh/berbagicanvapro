<!doctype html>
<html lang="id">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catatan Keuangan</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#121b33;
      --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --shadow:0 18px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Poppins', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(103,232,249,.25), transparent 55%),
        radial-gradient(900px 500px at 85% 20%, rgba(167,139,250,.22), transparent 55%),
        radial-gradient(900px 500px at 55% 90%, rgba(34,197,94,.16), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      /* HP-only layout */
      padding:calc(env(safe-area-inset-top) + 14px) 10px calc(env(safe-area-inset-bottom) + 22px);
    }

    .viewport{width:100%;display:flex;justify-content:stretch}
    .wrap{max-width:520px;width:100%;margin:0 auto}

    header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      margin-bottom:14px;
      flex-wrap:wrap;
      padding:0 2px;
    }

    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:40px;height:40px;border-radius:13px;
      background:linear-gradient(135deg, rgba(103,232,249,.9), rgba(167,139,250,.9));
      box-shadow: 0 10px 25px rgba(103,232,249,.18);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute;inset:9px;
      border-radius:11px;
      background:rgba(11,16,32,.55);
      border:1px solid rgba(255,255,255,.22);
      backdrop-filter: blur(8px);
    }

    h1{font-size:20px;margin:0;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}

    .toolbar{
      width:100%;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:8px;
      align-items:stretch;
    }
    .toolbar .btn{
      width:100%;
      padding:10px 10px;
      font-size:12px;
      line-height:1.1;
      border-radius:14px;
      min-height:42px;
      justify-content:center;
    }

    /* cards */
    .grid{display:grid;gap:12px}

    .card{
      background:linear-gradient(180deg, var(--card), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:12px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    }
    .card .head h3{margin:0;font-size:14px;letter-spacing:.3px}
    .badge{
      font-size:12px;color:var(--muted);
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      user-select:none;
    }
    .card .body{padding:14px 12px}

    /* form */
    .row{display:flex;gap:10px;flex-wrap:wrap}

    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}

    .field{flex:1;min-width:160px}
    .field.sm{min-width:140px;flex:0 0 170px}

    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,16,32,.35);
      color:var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    input::placeholder{color:rgba(255,255,255,.45)}
    input:focus, select:focus{border-color:rgba(103,232,249,.55); box-shadow: 0 0 0 4px rgba(103,232,249,.12)}

    .btn{
      padding:11px 14px;
      min-height:42px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:var(--text);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn:hover{transform: translateY(-1px); background:rgba(255,255,255,.12)}
    .btn:active{transform: translateY(0px)}

    .btn.primary{
      border-color: rgba(103,232,249,.35);
      background: linear-gradient(135deg, rgba(103,232,249,.22), rgba(167,139,250,.18));
    }

    .btn.danger{
      border-color: rgba(248,113,113,.35);
      background: linear-gradient(135deg, rgba(248,113,113,.22), rgba(248,113,113,.10));
      color: rgba(255,255,255,.95);
      font-weight: 750;
    }

    .btn.ghost{background:transparent}

    /* add button */
    .btn.addGreen{
      border-color: rgba(34,197,94,.38);
      background: linear-gradient(135deg, rgba(34,197,94,.28), rgba(34,197,94,.12));
      color: rgba(255,255,255,.95);
      font-weight: 750;
      padding:10px 12px;
      will-change: transform, width, height;
    }
    .btn.addGreen .plus{
      width:34px;height:34px;
      border-radius:12px;
      display:grid;place-items:center;
      background: rgba(34,197,94,.18);
      border: 1px solid rgba(34,197,94,.25);
    }
    .btn.addGreen svg{display:block}
    .btn.block{width:100%}

    /* Floating Add Button (single source: #openAddTab) */
    #addBtnSlot{width:100%}
    .btn.fab{
      position:fixed;
      right:14px;
      bottom:calc(env(safe-area-inset-bottom) + 14px);
      z-index:1190;
      width:56px;
      height:56px;
      padding:0;
      border-radius:18px;
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      transition:
        width .18s ease,
        height .18s ease,
        border-radius .18s ease,
        box-shadow .18s ease,
        transform .18s ease,
        background .18s ease,
        border-color .18s ease;
      animation: fabPop .18s ease-out;
    }
    @keyframes fabPop{
      from{transform: translateY(6px) scale(.96); opacity:.92}
      to{transform: translateY(0) scale(1); opacity:1}
    }
    .btn.fab .plus{width:40px;height:40px;border-radius:14px}
    .btn.fab span:last-child{display:none}

    /* summary pills */
    .stats{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .stat{
      padding:11px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      min-width:0;
    }
    .stat .k{font-size:11px;color:var(--muted);font-weight:650;letter-spacing:.15px}
    .stat .v{font-size:15px;font-weight:800;margin-top:6px;line-height:1.15;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    @media (max-width:420px){
      .stats{grid-template-columns: repeat(2, minmax(0, 1fr));}
    }
    @media (max-width:320px){
      .stats{grid-template-columns: 1fr;}
      .stat .v{font-size:16px}
    }
    .pos{color:rgba(34,197,94,.95)}
    .neg{color:rgba(248,113,113,.95)}

    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(103,232,249,.85)}
    .dot.exp{background:rgba(248,113,113,.9)}
    .dot.trf{background:rgba(167,139,250,.9)}

    /* filters */
    .filters{display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:6px;scroll-snap-type:x mandatory}
    .filters::-webkit-scrollbar{height:6px}
    .filters::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    .filterBtn{flex:0 0 auto; scroll-snap-align:start}

    .filterBtn{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      transition: transform .12s ease, background .12s ease;
    }
    .filterBtn:hover{transform: translateY(-1px); background:rgba(255,255,255,.10)}
    .filterBtn.active{color:var(--text); border-color:rgba(103,232,249,.35); background:rgba(103,232,249,.12)}

    /* transaksi filter dekat list */
    .txFilters{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:10px;
      align-items:end;
    }
    .txFilters .field{min-width:0}

    @media (max-width:420px){
      .txFilters{grid-template-columns: 1fr;}
    }

    .miniStats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media (max-width:360px){.miniStats{grid-template-columns:1fr}}

    .miniStat{
      padding:10px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
    }
    .miniStat .k{font-size:11px;color:var(--muted);font-weight:650;letter-spacing:.2px}
    .miniStat .v{font-size:13px;font-weight:750;margin-top:4px}

    /* transaksi list (group by date) */
    .txList{display:flex;flex-direction:column;gap:12px}
    .txDay{border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(11,16,32,.20);overflow:hidden}
    .txDayHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;background:rgba(255,255,255,.04);border-bottom:1px solid rgba(255,255,255,.08)}
    .txDayHead .d{font-size:12px;color:var(--muted);font-weight:650}
    .txDayHead .c{font-size:12px;color:var(--muted)}

    .txItem{display:flex;gap:10px;padding:12px;align-items:flex-start}
    .txItem + .txItem{border-top:1px solid rgba(255,255,255,.08)}
    .txMain{flex:1;min-width:0}
    .txTitle{display:flex;align-items:center;gap:8px;font-weight:750;font-size:13px}
    .txMeta{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .txNote{margin-top:6px;font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .txItem{cursor:pointer;transition:background .12s ease}
    .txItem:hover{background:rgba(255,255,255,.02)}
    .txItem:active{background:rgba(255,255,255,.04)}

    .txRight{display:flex;flex-direction:column;align-items:flex-end;gap:6px;min-width:112px}
    .txAmt{font-weight:850;font-size:14px;letter-spacing:.2px}
    .txChevron{font-size:18px;line-height:1;color:rgba(255,255,255,.55)}

    /* detail modal rows */
    .detailGrid{display:flex;flex-direction:column;gap:10px}
    .detailRow{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;padding:10px 10px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05)}
    .detailRow .k{font-size:11px;color:var(--muted);font-weight:650;letter-spacing:.15px}
    .detailRow .v{font-size:13px;font-weight:750;text-align:right;max-width:68%;word-break:break-word}

    /* transaksi modal form (rapi) */
    .txForm{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .txForm .field{min-width:0}
    .txForm .col2{grid-column: 1 / -1}

    @media (max-width:340px){
      .txForm{grid-template-columns: 1fr;}
    }

    /* manage modal */
    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .18s ease;z-index:1200}
    .modalMask.show{opacity:1;pointer-events:auto}

    .modal{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%) translateY(16px);
      width:min(520px, calc(100vw - 22px));
      background:linear-gradient(180deg, rgba(18,27,51,.95), rgba(11,16,32,.95));
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow:0 24px 60px rgba(0,0,0,.55);
      padding:12px 12px 12px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:1201;
      max-height: calc(100vh - 24px - env(safe-area-inset-top));
      overflow:auto;
    }
    .modal.show{opacity:1;pointer-events:auto; transform:translateX(-50%) translateY(0)}

    .modalHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:4px 4px 10px}
    .modalHead h3{margin:0;font-size:14px;letter-spacing:.2px}
    .modalBody{padding:0 4px 4px}

    .accTypeRow{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      margin-bottom:10px;
    }
    .accTypeMeta{font-size:11px;color:var(--muted);flex:1 0 100%}
    .accTypeRow input{
      flex:1;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,16,32,.35);
      color:var(--text);
    }
    .accTypeRow input.emojiIn{flex:0 0 64px;min-width:64px;text-align:center;font-size:18px;padding:10px 6px}
    .accTypeRow .num{flex:1 0 100%;min-width:100%;text-align:right}

    .iconMini{width:42px;height:42px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08);color:var(--text);cursor:pointer}
    .modalFooter{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding:4px;
    }
    .modalFooter .btn{width:100%}

    /* spacers (rapi tanpa inline height) */
    .sp6{height:6px}
    .sp10{height:10px}
    .sp12{height:12px}
    .sp14{height:14px}

    /* small screens tune */
    @media (max-width:360px){
      .toolbar{grid-template-columns: 1fr 1fr;}
      .toolbar .btn{font-size:12px}
      .txRight{min-width:98px}
    }

    /* toast */
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      padding:10px 12px;border-radius:14px;
      background:rgba(0,0,0,.55);
      color:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 16px 30px rgba(0,0,0,.35);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      backdrop-filter: blur(10px);
      font-size:13px;
      z-index:999;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}

    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);margin-top:10px}
    .hidden{display:none !important}
  </style>
</head>
<body class="phone">
  <div class="viewport">
    <div class="wrap" id="appWrap">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Catatan Keuangan</h1>
            <div class="sub">Demo ringan ‚Ä¢ hitung pemasukan, pengeluaran, & transfer</div>
          </div>
        </div>

        <div class="toolbar">
          <button class="btn ghost" id="seedBtn" title="Isi contoh data">Isi contoh</button>
          <button class="btn ghost" id="resetBtn" title="Hapus semua transaksi">Reset</button>
          <button class="btn" id="exportBtn" title="Backup full: download semua transaksi ke spreadsheet (CSV)">Backup CSV</button>
        </div>
      </header>

      <!-- top summary -->
      <section class="card" id="summaryCard" style="margin-bottom:12px">
        <div class="head">
          <h3>Ringkasan</h3>
          <span class="badge" id="countBadge">0 transaksi</span>
        </div>
        <div class="body">
          <div class="stats">
            <div class="stat">
              <div class="k">Total pemasukan</div>
              <div class="v pos" id="sumIncome">Rp 0</div>
            </div>
            <div class="stat">
              <div class="k">Total pengeluaran</div>
              <div class="v neg" id="sumExpense">Rp 0</div>
            </div>
            <div class="stat">
              <div class="k">Saldo</div>
              <div class="v" id="balance">Rp 0</div>
            </div>
          </div>
          <div class="sp12"></div>

          <div class="sp10"></div>
          <div class="row" style="justify-content:space-between;align-items:center;flex-wrap:nowrap">
            <span class="chip" id="modeChip"><span class="dot" id="modeDot"></span><span id="modeText">Mode: Pemasukan</span></span>
            <span class="chip"><span class="dot" style="background:rgba(255,255,255,.45)"></span><span>Mode HP</span></span>
          </div>

          <div class="sp10"></div>
          <div class="row" style="flex-direction:column;gap:10px">
            <div style="min-width:100%">
              <div class="k" style="font-size:12px;color:var(--muted);margin-bottom:6px">Filter akun</div>
              <div class="filters" id="acctFilters"></div>
            </div>
            <div class="row" style="gap:8px;display:grid;grid-template-columns:1fr 1fr">
              <button class="btn ghost" id="manageAccTypesBtn" type="button" title="Tambah / edit jenis akun">Kelola Akun</button>
              <button class="btn ghost" id="manageCatsTopBtn" type="button" title="Tambah / edit kategori">Kelola Kategori</button>
            </div>
          </div>

          <div class="sp12"></div>
          <div class="miniStats" id="acctStats"></div>
        </div>
      </section>

      <div id="addBtnSlot">
        <button class="btn addGreen block" id="openAddTab" type="button" title="Tambah transaksi" aria-label="Tambah transaksi">
          <span class="plus" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 5v14" />
              <path d="M5 12h14" />
            </svg>
          </span>
          <span>Tambah</span>
        </button>
      </div>

      <div class="sp14"></div>

      <div class="grid">
        <section class="card">
          <div class="head">
            <h3>Transaksi</h3>
            <span class="badge">Daftar transaksi</span>
          </div>
          <div class="body">
            <div class="txFilters">
              <div class="field">
                <label for="search">Pencarian</label>
                <input id="search" type="text" placeholder="cari kategori/catatan‚Ä¶" />
              </div>
              <div class="field sm">
                <label for="month">Filter bulan</label>
                <input id="month" type="month" />
              </div>
            </div>

            <div class="sp10"></div>
            <div class="hint">Klik tombol <b>Tambah</b> di atas untuk mengisi detail transaksi.</div>
            <div class="sp14"></div>
            <div class="txList" id="txList"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Manage Account Types Modal -->
  <div class="modalMask" id="accTypeMask"></div>
  <div class="modal" id="accTypeModal" aria-hidden="true">
    <div class="modalHead">
      <h3>Kelola Jenis Akun</h3>
      <button class="iconMini" id="closeAccTypeModal" type="button" aria-label="Tutup">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="muted" style="font-size:12px;margin:0 0 10px">Ubah emoji, nama akun, dan <b>saldo awal</b> (opsional). ID dibuat otomatis.</div>
      <div id="accTypeList"></div>

      <div class="accTypeRow" style="margin-top:6px">
        <div class="accTypeMeta">Tambah</div>
        <input class="emojiIn" id="newAccTypeEmoji" type="text" maxlength="4" placeholder="üí≥" />
        <input id="newAccTypeName" type="text" placeholder="Contoh: Investasi" />
        <button class="iconMini" id="addAccTypeBtn" type="button" title="Tambah">Ôºã</button>
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn" id="cancelAccTypeBtn" type="button">Batal</button>
      <button class="btn primary" id="saveAccTypeBtn" type="button">Simpan</button>
    </div>
  </div>

  <!-- Manage Categories Modal -->
  <div class="modalMask" id="catMask"></div>
  <div class="modal" id="catModal" aria-hidden="true">
    <div class="modalHead">
      <h3>Kelola Kategori</h3>
      <button class="iconMini" id="closeCatModal" type="button" aria-label="Tutup">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="muted" style="font-size:12px;margin:0 0 10px">Ubah emoji/nama kategori atau tambah kategori baru. Nama kategori akan otomatis ikut berubah di transaksi lama (karena pakai ID).</div>
      <div id="catList"></div>

      <div class="accTypeRow" style="margin-top:6px">
        <div class="accTypeMeta">Tambah</div>
        <input class="emojiIn" id="newCatEmoji" type="text" maxlength="4" placeholder="üè∑Ô∏è" />
        <input id="newCatName" type="text" placeholder="Contoh: Kesehatan" />
        <button class="iconMini" id="addCatBtn" type="button" title="Tambah">Ôºã</button>
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn" id="cancelCatBtn" type="button">Batal</button>
      <button class="btn primary" id="saveCatBtn" type="button">Simpan</button>
    </div>
  </div>

  <!-- Add Transaction Tab (Sheet) -->
  <div class="modalMask" id="txMask"></div>
  <div class="modal" id="txModal" aria-hidden="true" style="bottom:12px">
    <div class="modalHead">
      <h3>Tambah transaksi</h3>
      <button class="iconMini" id="closeTxModal" type="button" aria-label="Tutup">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="muted" style="font-size:12px;margin:0 0 10px">Isi detail transaksi, lalu simpan.</div>

      <div class="txForm">
        <div class="field sm">
          <label for="type">Tipe</label>
          <select id="type">
            <option value="income">Pemasukan</option>
            <option value="expense">Pengeluaran</option>
            <option value="transfer">Transfer</option>
          </select>
        </div>

        <div class="field sm">
          <label for="amount">Nominal</label>
          <input id="amount" type="number" inputmode="numeric" min="0" step="100" placeholder="50000" />
        </div>

        <div class="field sm">
          <label for="date">Tanggal</label>
          <input id="date" type="date" />
        </div>

        <div class="field sm" id="singleAcctField">
          <label for="acctType">Akun</label>
          <select id="acctType"></select>
        </div>

        <div class="field sm hidden" id="transferFromField">
          <label for="transferFrom">Dari akun</label>
          <select id="transferFrom"></select>
        </div>

        <div class="field sm hidden" id="transferToField">
          <label for="transferTo">Ke akun</label>
          <select id="transferTo"></select>
        </div>

        <div class="field col2" id="categoryField">
          <label for="category">Kategori</label>
          <select id="category"></select>
          <div class="hint" style="margin-top:8px">Kelola kategori ada di <b>Ringkasan</b> (bagian atas).</div>
        </div>

        <div class="field col2">
          <label for="note">Catatan</label>
          <input id="note" type="text" placeholder="opsional" />
        </div>
      </div>

      <div class="hint" style="margin-top:12px">Tips: Transfer akan memindahkan saldo antar akun (misal Bank ‚Üí E-Wallet).</div>
    </div>
    <div class="modalFooter">
      <button class="btn" id="cancelTxBtn" type="button">Batal</button>
      <button class="btn primary" id="addBtn" type="button">Simpan</button>
    </div>
  </div>

  <!-- Reset Confirm Modal -->
  <div class="modalMask" id="resetMask"></div>
  <div class="modal" id="resetModal" aria-hidden="true" style="bottom:12px">
    <div class="modalHead">
      <h3>Konfirmasi Reset</h3>
      <button class="iconMini" id="closeResetModal" type="button" aria-label="Tutup">‚úï</button>
    </div>
    <div class="modalBody">
      <div style="display:flex;gap:10px;align-items:flex-start">
        <div style="width:42px;height:42px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(248,113,113,.12);display:grid;place-items:center;font-size:18px">‚ö†Ô∏è</div>
        <div>
          <div style="font-weight:750">Hapus semua transaksi?</div>
          <div class="muted" style="font-size:12px;margin-top:4px;line-height:1.4">
            Tindakan ini akan menghapus <b>seluruh</b> riwayat transaksi dari perangkat ini. Tidak bisa dibatalkan.
          </div>
          <div class="hint" style="margin-top:10px">Saran: tekan <b>Backup CSV</b> dulu kalau ingin menyimpan data.</div>
        </div>
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn" id="cancelResetBtn" type="button">Batal</button>
      <button class="btn danger" id="confirmResetBtn" type="button">Ya, Reset</button>
    </div>
  </div>

  <!-- Transaction Detail Modal -->
  <div class="modalMask" id="txDetailMask"></div>
  <div class="modal" id="txDetailModal" aria-hidden="true" style="bottom:12px">
    <div class="modalHead">
      <h3>Detail transaksi</h3>
      <button class="iconMini" id="closeTxDetail" type="button" aria-label="Tutup">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="muted" style="font-size:12px;margin:0 0 10px">Klik <b>Edit</b> untuk mengubah, atau <b>Hapus</b> untuk menghapus transaksi.</div>
      <div class="detailGrid" id="txDetailGrid"></div>
      <div class="hint" id="txDetailHint" style="margin-top:12px"></div>
    </div>
    <div class="modalFooter">
      <button class="btn" id="txDetailCloseBtn" type="button">Tutup</button>
      <button class="btn primary" id="txDetailEditBtn" type="button">Edit</button>
    </div>
    <div style="padding:0 4px 6px">
      <button class="btn danger block" id="txDetailDeleteBtn" type="button">Hapus transaksi</button>
    </div>
  </div>

  <div class="toast" id="toast">Tersimpan.</div>

<script>
  // ===== Keys (local) =====
  const KEY_TX = 'finance_tx_v3';
  const KEY_TYPES = 'finance_account_types_v1';
  const KEY_CATS = 'finance_categories_v1';

  // ===== Helpers =====
  const $ = (id) => document.getElementById(id);
  const fmt = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n || 0);
  const toast = (msg) => {
    const t = $('toast');
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => t.classList.remove('show'), 1400);
  };
  const todayISO = () => new Date().toISOString().slice(0, 10);
  const monthOf = (d) => (d || '').slice(0, 7);

  function csvEscape(v){
    const s = String(v ?? '');
    const need = /[",
]/.test(s);
    const out = s.replaceAll('"','""');
    return need ? `"${out}"` : out;
  }

  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function slugifyLabel(label) {
    return String(label || '')
      .trim()
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '')
      .slice(0, 24) || 'item';
  }

  function uniqId(base, existsFn) {
    let id = base;
    let i = 2;
    while (existsFn(id)) id = `${base}-${i++}`;
    return id;
  }

  // ===== Storage =====
  function loadJson(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    } catch {
      return fallback;
    }
  }
  function saveJson(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  // ===== State =====
  let tx = loadJson(KEY_TX, []);
  let accountFilter = 'all'; // all | <typeId>

  let accountTypes = loadJson(KEY_TYPES, null);
  if (!Array.isArray(accountTypes) || accountTypes.length === 0) {
    accountTypes = [
      { id: 'cash', label: 'Cash', emoji: 'üíµ', opening: 0 },
      { id: 'bank', label: 'Bank', emoji: 'üè¶', opening: 0 },
      { id: 'ewallet', label: 'E-Wallet', emoji: 'üì±', opening: 0 },
    ];
  } else {
    accountTypes = accountTypes
      .filter((x) => x && typeof x.id === 'string' && typeof x.label === 'string')
      .map((x) => ({ id: x.id, label: x.label, emoji: (typeof x.emoji === 'string' ? x.emoji : ''), opening: Number(x.opening || 0) }))
      .slice(0, 12);
  }

  let categories = loadJson(KEY_CATS, null);
  if (!Array.isArray(categories) || categories.length === 0) {
    categories = [
      { id: 'gaji', label: 'Gaji', emoji: 'üíº' },
      { id: 'makan', label: 'Makan', emoji: 'üçú' },
      { id: 'transport', label: 'Transport', emoji: 'üöå' },
      { id: 'belanja', label: 'Belanja', emoji: 'üõí' },
      { id: 'hiburan', label: 'Hiburan', emoji: 'üéÆ' },
      { id: 'freelance', label: 'Freelance', emoji: 'üßë‚Äçüíª' },
      { id: 'transfer', label: 'Transfer', emoji: 'üîÅ' },
    ];
  } else {
    categories = categories
      .filter((x) => x && typeof x.id === 'string' && typeof x.label === 'string')
      .map((x) => ({ id: x.id, label: x.label, emoji: (typeof x.emoji === 'string' ? x.emoji : '') }))
      .slice(0, 30);
  }

  function saveTx() { saveJson(KEY_TX, tx); }
  function saveTypes() { saveJson(KEY_TYPES, accountTypes); }
  function saveCats() { saveJson(KEY_CATS, categories); }

  // ===== Migration: past tx category string -> categoryId =====
  function normalizeTx() {
    let changed = false;

    for (const t of tx) {
      if (!t.accountType && t.type !== 'transfer') {
        t.accountType = accountTypes[0]?.id || 'cash';
        changed = true;
      }

      if (!t.categoryId) {
        const legacy = (t.category || '').trim();
        if (legacy) {
          const hit = categories.find((c) => c.label.toLowerCase() === legacy.toLowerCase());
          if (hit) {
            t.categoryId = hit.id;
            changed = true;
          } else {
            const base = uniqId(slugifyLabel(legacy), (id) => categories.some((c) => c.id === id));
            categories.push({ id: base, label: legacy, emoji: 'üè∑Ô∏è' });
            t.categoryId = base;
            changed = true;
          }
        }
      }
    }

    if (changed) {
      saveCats();
      saveTx();
    }
  }
  normalizeTx();

  // ===== Lookup =====
  function acctLabel(id) {
    const a = accountTypes.find((x) => x.id === id);
    if (!a) return id || 'Akun';
    return `${a.emoji ? a.emoji + ' ' : ''}${a.label}`.trim();
  }
  function acctLabelPlain(id){
    const a = accountTypes.find((x) => x.id === id);
    return a ? a.label : (id || 'Akun');
  }
  function catLabel(id) {
    const c = categories.find((x) => x.id === id);
    if (!c) return id || 'Kategori';
    return `${c.emoji ? c.emoji + ' ' : ''}${c.label}`.trim();
  }
  function catLabelPlain(id){
    const c = categories.find((x) => x.id === id);
    return c ? c.label : (id || 'Kategori');
  }
  function ensureCategory(label) {
    const v = String(label || '').trim();
    if (!v) return categories[0]?.id;
    const hit = categories.find((c) => c.label.toLowerCase() === v.toLowerCase());
    if (hit) return hit.id;
    const base = uniqId(slugifyLabel(v), (id) => categories.some((c) => c.id === id));
    categories.push({ id: base, label: v, emoji: 'üè∑Ô∏è' });
    saveCats();
    return base;
  }

  // ===== Filtering =====
  function monthMatch(t) {
    const m = $('month').value;
    return !m || monthOf(t.date) === m;
  }

  function accountMatch(t) {
    if (accountFilter === 'all') return true;

    if (t.type === 'transfer') {
      const fromId = t.fromAccountType || t.accountType || (accountTypes[0]?.id || 'cash');
      const toId = t.toAccountType || (accountTypes[0]?.id || 'cash');
      return fromId === accountFilter || toId === accountFilter;
    }

    const tid = (t.accountType || accountTypes[0]?.id || 'cash');
    return tid === accountFilter;
  }

  function getMonthBase() {
    return tx.filter((t) => monthMatch(t));
  }

  function getBaseForTotals() {
    return getMonthBase().filter((t) => accountMatch(t));
  }

  function getListFiltered() {
    const q = ($('search').value || '').trim().toLowerCase();
    return getBaseForTotals()
      .filter((t) => {
        if (!q) return true;
        const cat = catLabel(t.categoryId || '');
        const acct = acctLabel(t.accountType || '');
        const from = acctLabel(t.fromAccountType || '');
        const to = acctLabel(t.toAccountType || '');
        return (`${cat} ${acct} ${from} ${to} ${t.note || ''}`.toLowerCase().includes(q));
      })
      .sort((a, b) => (b.date || '').localeCompare(a.date || ''));
  }

  // ===== UI rendering =====
  function renderAccountTypeSelect() {
    const fill = (selId) => {
      const sel = $(selId);
      if (!sel) return;
      const current = sel.value;
      sel.innerHTML = '';
      for (const t of accountTypes) {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = `${t.emoji ? t.emoji + ' ' : ''}${t.label}`.trim();
        sel.appendChild(opt);
      }
      if (accountTypes.some((t) => t.id === current)) sel.value = current;
      else sel.value = accountTypes[0]?.id || 'cash';
    };

    fill('acctType');
    fill('transferFrom');
    fill('transferTo');
  }

  function renderCategorySelect() {
    const sel = $('category');
    const current = sel.value;
    sel.innerHTML = '';

    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = 'Pilih kategori‚Ä¶';
    sel.appendChild(ph);

    for (const c of categories) {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = `${c.emoji ? c.emoji + ' ' : ''}${c.label}`.trim();
      sel.appendChild(opt);
    }

    if (categories.some((c) => c.id === current)) sel.value = current;
    else sel.value = '';
  }

  function renderAccountTypeFilters() {
    const wrap = $('acctFilters');
    wrap.innerHTML = '';

    const mkBtn = (label, id) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'filterBtn' + ((accountFilter === id) ? ' active' : '');
      b.dataset.acct = id;
      b.textContent = label;
      b.addEventListener('click', () => {
        accountFilter = id;
        render();
      });
      return b;
    };

    wrap.appendChild(mkBtn('Semua', 'all'));
    for (const t of accountTypes) wrap.appendChild(mkBtn(`${t.emoji ? t.emoji + ' ' : ''}${t.label}`.trim(), t.id));
  }

  function renderAccountTypeStats(monthBase) {
    const bal = {};
    for (const t of accountTypes) bal[t.id] = Number(t.opening || 0);

    for (const it of monthBase) {
      if (it.type === 'transfer') {
        const fromId = it.fromAccountType || it.accountType || (accountTypes[0]?.id);
        const toId = it.toAccountType || (accountTypes[0]?.id);
        if (fromId) bal[fromId] = (bal[fromId] || 0) - (it.amount || 0);
        if (toId) bal[toId] = (bal[toId] || 0) + (it.amount || 0);
        continue;
      }

      const tid = (it.accountType || accountTypes[0]?.id);
      if (!tid) continue;
      bal[tid] = (bal[tid] || 0) + ((it.type === 'income') ? it.amount : -it.amount);
    }

    const box = $('acctStats');
    box.innerHTML = '';
    for (const t of accountTypes) {
      const card = document.createElement('div');
      card.className = 'miniStat';
      card.innerHTML = `
        <div class="k">${escapeHtml(`${t.emoji ? t.emoji + ' ' : ''}${t.label}`.trim())}</div>
        <div class="v">${fmt(bal[t.id] || 0)}</div>
      `;
      box.appendChild(card);
    }
  }

  // ===== Main render =====
  function render() {
    renderAccountTypeSelect();
    renderCategorySelect();

    const monthBase = getMonthBase();
    const baseForTotals = getBaseForTotals();
    const list = getListFiltered();

    let inc = 0, exp = 0;
    for (const t of baseForTotals) {
      if (t.type === 'transfer') continue;
      if (t.type === 'income') inc += t.amount;
      else exp += t.amount;
    }

    $('sumIncome').textContent = fmt(inc);
    $('sumExpense').textContent = fmt(exp);

    const openingSum = (accountFilter === 'all')
      ? accountTypes.reduce((s, a) => s + Number(a.opening || 0), 0)
      : Number(accountTypes.find((a) => a.id === accountFilter)?.opening || 0);

    $('balance').textContent = fmt(openingSum + (inc - exp));

    $('countBadge').textContent = `${list.length} transaksi`;

    renderAccountTypeFilters();
    renderAccountTypeStats(monthBase);

    const box = $('txList');
    box.innerHTML = '';

    if (list.length === 0) {
      box.innerHTML = `<div class="muted" style="font-size:13px">Belum ada transaksi untuk filter ini.</div>`;
      return;
    }

    const prettyDate = (iso) => {
      try {
        return new Intl.DateTimeFormat('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }).format(new Date(iso));
      } catch {
        return iso;
      }
    };

    const groups = new Map();
    for (const t of list) {
      const d = t.date || '';
      if (!groups.has(d)) groups.set(d, []);
      groups.get(d).push(t);
    }

    const dates = Array.from(groups.keys()).sort((a, b) => (b || '').localeCompare(a || ''));

    for (const d of dates) {
      const dayWrap = document.createElement('div');
      dayWrap.className = 'txDay';

      const items = groups.get(d) || [];
      const head = document.createElement('div');
      head.className = 'txDayHead';
      head.innerHTML = `<div class="d">${escapeHtml(prettyDate(d))}</div><div class="c">${items.length} item</div>`;
      dayWrap.appendChild(head);

      for (const t of items) {
        const isTransfer = t.type === 'transfer';
        const isExp = t.type === 'expense';
        const label = isTransfer ? 'Transfer' : (isExp ? 'Pengeluaran' : 'Pemasukan');

        const fromId = t.fromAccountType || t.accountType || '';
        const toId = t.toAccountType || '';
        const acctText = isTransfer ? `${acctLabel(fromId)} ‚Üí ${acctLabel(toId)}` : acctLabel(t.accountType || '');
        const catText = catLabel(t.categoryId || '') || (t.category || '');

        const item = document.createElement('div');
        item.className = 'txItem';
        item.setAttribute('role','button');
        item.setAttribute('tabindex','0');
        item.dataset.id = t.id;

        const amt = isTransfer ? (t.amount || 0) : (isExp ? -t.amount : t.amount);
        const amtCls = isTransfer ? 'muted' : (isExp ? 'neg' : 'pos');

        item.innerHTML = `
          <div class="txMain">
            <div class="txTitle">
              <span class="chip"><span class="dot ${isTransfer ? 'trf' : (isExp ? 'exp' : '')}"></span>${label}</span>
              <span style="font-weight:750">${escapeHtml(catText || (isTransfer ? 'Transfer' : ''))}</span>
            </div>
            <div class="txMeta">
              <span class="chip">${escapeHtml(acctText)}</span>
            </div>
            ${t.note ? `<div class="txNote">${escapeHtml(t.note)}</div>` : ``}
          </div>
          <div class="txRight">
            <div class="txAmt ${amtCls}">${fmt(amt)}</div>
            <div class="txChevron" aria-hidden="true">‚Ä∫</div>
          </div>
        `;

        item.addEventListener('click', () => openTxDetail(t.id));
        item.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openTxDetail(t.id);
          }
        });

        dayWrap.appendChild(item);
      }

      box.appendChild(dayWrap);
    }
  }

  // ===== Actions =====
  let editingTxId = null;
  let detailTxId = null;
  let lastNonTransferCategoryId = '';

  function clearEditMode(){
    editingTxId = null;
    try{ $('txModal').querySelector('h3').textContent = 'Tambah transaksi'; }catch{}
    try{ $('addBtn').textContent = 'Simpan'; }catch{}
  }

  function resetTxForm(){
    $('type').value = 'income';
    $('amount').value = '';
    $('note').value = '';
    $('category').value = '';
    $('date').value = todayISO();
    $('acctType').value = accountTypes[0]?.id || 'cash';
    $('transferFrom').value = accountTypes[0]?.id || 'cash';
    $('transferTo').value = (accountTypes[1]?.id || accountTypes[0]?.id || 'cash');
    $('type').dispatchEvent(new Event('change'));
  }

  function upsertTx(obj){
    if (!editingTxId) {
      tx.push(obj);
      return;
    }
    const i = tx.findIndex((x) => x.id === editingTxId);
    if (i === -1) tx.push(obj);
    else tx[i] = { ...tx[i], ...obj, id: editingTxId };
  }

  function deleteTxById(id){
    tx = tx.filter((x) => x.id !== id);
    saveTx();
    render();
    toast('Transaksi dihapus');
  }

  function openTxDetail(id){
    const t = tx.find((x) => x.id === id);
    if (!t) return;
    detailTxId = id;

    const isTransfer = t.type === 'transfer';
    const isExp = t.type === 'expense';
    const label = isTransfer ? 'Transfer' : (isExp ? 'Pengeluaran' : 'Pemasukan');

    const pretty = (iso) => {
      try {
        return new Intl.DateTimeFormat('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }).format(new Date(iso));
      } catch {
        return iso;
      }
    };

    const amt = isTransfer ? (t.amount || 0) : (isExp ? -t.amount : t.amount);

    const rows = [
      { k:'Tipe', v: label },
      { k:'Tanggal', v: pretty(t.date || '') },
      { k:'Nominal', v: fmt(amt) },
      { k:'Kategori', v: catLabel(t.categoryId || '') },
    ];

    if (isTransfer) {
      const fromId = t.fromAccountType || t.accountType || (accountTypes[0]?.id || 'cash');
      const toId = t.toAccountType || (accountTypes[0]?.id || 'cash');
      rows.push({ k:'Dari akun', v: acctLabel(fromId) });
      rows.push({ k:'Ke akun', v: acctLabel(toId) });
    } else {
      rows.push({ k:'Akun', v: acctLabel(t.accountType || (accountTypes[0]?.id || 'cash')) });
    }

    if (t.note) rows.push({ k:'Catatan', v: t.note });

    $('txDetailGrid').innerHTML = rows.map(r => `
      <div class="detailRow">
        <div class="k">${escapeHtml(r.k)}</div>
        <div class="v">${escapeHtml(r.v)}</div>
      </div>
    `).join('');

    $('txDetailHint').textContent = `ID: ${t.id}`;

    $('txDetailDeleteBtn').dataset.stage = '';
    $('txDetailDeleteBtn').textContent = 'Hapus transaksi';

    $('txDetailMask').classList.add('show');
    $('txDetailModal').classList.add('show');
    $('txDetailModal').setAttribute('aria-hidden', 'false');
  }

  function closeTxDetail(){
    $('txDetailMask').classList.remove('show');
    $('txDetailModal').classList.remove('show');
    $('txDetailModal').setAttribute('aria-hidden', 'true');
    detailTxId = null;
  }

  function startEditTx(id){
    const t = tx.find((x) => x.id === id);
    if (!t) return;
    editingTxId = id;

    $('txModal').querySelector('h3').textContent = 'Edit transaksi';
    $('addBtn').textContent = 'Simpan perubahan';

    $('type').value = t.type || 'income';
    $('type').dispatchEvent(new Event('change'));

    $('amount').value = Number(t.amount || 0);
    $('date').value = t.date || todayISO();
    $('note').value = t.note || '';
    $('category').value = t.categoryId || '';

    if (t.type === 'transfer') {
      $('transferFrom').value = t.fromAccountType || t.accountType || (accountTypes[0]?.id || 'cash');
      $('transferTo').value = t.toAccountType || (accountTypes[0]?.id || 'cash');
    } else {
      $('acctType').value = t.accountType || (accountTypes[0]?.id || 'cash');
    }

    openTxModal();
  }

  function addTx() {
    const type = $('type').value;
    const amount = Number($('amount').value);
    const date = $('date').value;
    const note = ($('note').value || '').trim();
    const categoryIdInput = $('category').value || '';

    if (!date) return toast('Tanggal wajib diisi');
    if (!amount || amount <= 0) return toast('Nominal harus > 0');

    const id = editingTxId || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()));

    if (type === 'transfer') {
      const fromAccountType = $('transferFrom').value || accountTypes[0]?.id || 'cash';
      const toAccountType = $('transferTo').value || accountTypes[0]?.id || 'cash';
      if (fromAccountType === toAccountType) return toast('Akun asal & tujuan harus beda');

      const transferCatId = categoryIdInput || ensureCategory('Transfer');

      upsertTx({
        id,
        type: 'transfer',
        amount,
        date,
        categoryId: transferCatId,
        fromAccountType,
        toAccountType,
        accountType: fromAccountType,
        note,
      });

      saveTx();
      render();
      closeTxModal();
      toast(editingTxId ? 'Perubahan disimpan' : 'Transfer dicatat');
      clearEditMode();
      resetTxForm();
      return;
    }

    const accountType = $('acctType').value || accountTypes[0]?.id || 'cash';
    const categoryId = categoryIdInput;
    if (!categoryId) return toast('Kategori wajib diisi');

    upsertTx({
      id,
      type,
      amount,
      date,
      categoryId,
      accountType,
      fromAccountType: null,
      toAccountType: null,
      note,
    });

    saveTx();
    render();
    closeTxModal();
    toast(editingTxId ? 'Perubahan disimpan' : 'Transaksi ditambahkan');
    clearEditMode();
    resetTxForm();
  }

  function seed() {
    const base = todayISO();
    const d = (daysAgo) => {
      const dt = new Date();
      dt.setDate(dt.getDate() - daysAgo);
      return dt.toISOString().slice(0, 10);
    };

    const firstAcct = accountTypes[0]?.id || 'cash';
    const pickAcct = (id) => accountTypes.some((t) => t.id === id) ? id : firstAcct;

    const pickCat = (label) => {
      const hit = categories.find((c) => c.label.toLowerCase() === String(label).toLowerCase());
      return hit ? hit.id : ensureCategory(label);
    };

    tx = [
      { id: '1', type: 'income', amount: 5500000, date: d(8), categoryId: pickCat('Gaji'), accountType: pickAcct('bank'), note: 'Payroll' },
      { id: '2', type: 'expense', amount: 65000, date: d(7), categoryId: pickCat('Makan'), accountType: pickAcct('ewallet'), note: 'Sarapan' },
      { id: '3', type: 'expense', amount: 120000, date: d(6), categoryId: pickCat('Transport'), accountType: pickAcct('cash'), note: 'Bensin' },
      { id: '4', type: 'expense', amount: 250000, date: d(5), categoryId: pickCat('Belanja'), accountType: pickAcct('bank'), note: 'Kebutuhan rumah' },
      { id: '5', type: 'income', amount: 300000, date: d(3), categoryId: pickCat('Freelance'), accountType: pickAcct('bank'), note: 'Project kecil' },
      { id: '6', type: 'expense', amount: 89000, date: d(2), categoryId: pickCat('Hiburan'), accountType: pickAcct('ewallet'), note: 'Nonton' },
      { id: '7', type: 'transfer', amount: 250000, date: d(1), categoryId: pickCat('Transfer'), fromAccountType: pickAcct('bank'), toAccountType: pickAcct('ewallet'), accountType: pickAcct('bank'), note: 'Top up e-wallet' },
    ];

    $('month').value = monthOf(base);
    $('search').value = '';
    saveTx();
    render();
    toast('Contoh data terisi');
  }

  function openResetConfirm(){
    if (!Array.isArray(tx) || tx.length === 0) {
      toast('Tidak ada data untuk direset');
      return;
    }
    closeTxModal();
    closeTxDetail();
    closeAccTypeModal();
    closeCatModal();

    $('resetMask').classList.add('show');
    $('resetModal').classList.add('show');
    $('resetModal').setAttribute('aria-hidden','false');
  }

  function closeResetConfirm(){
    $('resetMask').classList.remove('show');
    $('resetModal').classList.remove('show');
    $('resetModal').setAttribute('aria-hidden','true');
  }

  function resetAll() {
    tx = [];
    $('search').value = '';
    $('month').value = '';
    saveTx();
    render();
    toast('Data direset');
  }

  function exportCSV() {
    if (!Array.isArray(tx) || tx.length === 0) {
      toast('Tidak ada data untuk diekspor');
      return;
    }

    const rows = [];
    rows.push([
      'ID',
      'Tanggal',
      'Bulan',
      'Tipe',
      'Jumlah',
      'Kategori',
      'KategoriID',
      'Akun',
      'AkunID',
      'Dari Akun',
      'DariAkunID',
      'Ke Akun',
      'KeAkunID',
      'Catatan'
    ]);

    const typeText = (t) => (t === 'income' ? 'Pemasukan' : (t === 'expense' ? 'Pengeluaran' : 'Transfer'));
    const data = [...tx].sort((a,b) => (a.date || '').localeCompare(b.date || ''));

    for (const t of data) {
      const isTransfer = t.type === 'transfer';
      const date = t.date || '';
      const month = monthOf(date);
      const jumlah = Number(t.amount || 0);

      const cat = catLabelPlain(t.categoryId || '') || '';
      const akun = (!isTransfer) ? acctLabelPlain(t.accountType || '') : '';
      const dari = isTransfer ? acctLabelPlain(t.fromAccountType || t.accountType || '') : '';
      const ke = isTransfer ? acctLabelPlain(t.toAccountType || '') : '';

      rows.push([
        t.id || '',
        date,
        month,
        typeText(t.type),
        jumlah,
        cat,
        (t.categoryId || ''),
        akun,
        (!isTransfer ? (t.accountType || '') : ''),
        dari,
        (isTransfer ? (t.fromAccountType || t.accountType || '') : ''),
        ke,
        (isTransfer ? (t.toAccountType || '') : ''),
        t.note || '',
      ]);
    }

    const csv = 'Ôªø' + rows.map(r => r.map(csvEscape).join(',')).join('
');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });

    const a = document.createElement('a');
    const ts = todayISO();
    a.href = URL.createObjectURL(blob);
    a.download = `catatan-keuangan_${ts}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    toast('Backup CSV terunduh');
  }

  // ===== Manage Account Types Modal =====
  function openAccTypeModal() {
    $('accTypeMask').classList.add('show');
    $('accTypeModal').classList.add('show');
    $('accTypeModal').setAttribute('aria-hidden', 'false');
    renderAccTypeEditor();
  }
  function closeAccTypeModal() {
    $('accTypeMask').classList.remove('show');
    $('accTypeModal').classList.remove('show');
    $('accTypeModal').setAttribute('aria-hidden', 'true');
    $('newAccTypeName').value = '';
    $('newAccTypeEmoji').value = '';
  }

  function renderAccTypeEditor() {
    const list = $('accTypeList');
    list.innerHTML = '';

    for (const t of accountTypes) {
      const row = document.createElement('div');
      row.className = 'accTypeRow';
      row.innerHTML = `
        <div class="accTypeMeta">ID: ${escapeHtml(t.id)}</div>
        <input class="emojiIn" type="text" maxlength="4" value="${escapeHtml(t.emoji || '')}" data-id-emoji="${escapeHtml(t.id)}" placeholder="üí≥" />
        <input type="text" value="${escapeHtml(t.label)}" data-id-label="${escapeHtml(t.id)}" />
        <input class="num" type="number" inputmode="numeric" min="0" step="100" value="${Number(t.opening || 0)}" data-id-open="${escapeHtml(t.id)}" placeholder="Saldo awal" />
        <button class="iconMini" type="button" data-del="${escapeHtml(t.id)}" title="Hapus">üóë</button>
      `;
      list.appendChild(row);
    }

    list.querySelectorAll('button[data-del]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-del');
        if (accountTypes.length <= 1) return toast('Minimal 1 jenis akun');

        if (btn.dataset.stage !== 'confirm') {
          list.querySelectorAll('button[data-del]').forEach((b) => {
            b.dataset.stage = '';
            b.textContent = 'üóë';
          });

          btn.dataset.stage = 'confirm';
          btn.textContent = 'Hapus?';
          toast('Klik sekali lagi untuk hapus');

          clearTimeout(window.__delTypeTimer);
          window.__delTypeTimer = setTimeout(() => {
            btn.dataset.stage = '';
            btn.textContent = 'üóë';
          }, 1400);
          return;
        }

        const fallback = accountTypes.find((x) => x.id !== id)?.id;
        if (!fallback) return;

        const removed = accountTypes.find((x) => x.id === id);
        const removedOpening = Number(removed?.opening || 0);

        // merge saldo awal ke akun fallback biar total tidak hilang
        accountTypes = accountTypes.map((x) => {
          if (x.id !== fallback) return x;
          return { ...x, opening: Number(x.opening || 0) + removedOpening };
        });

        // reassign tx
        tx = tx.map((t) => {
          if (t.type === 'transfer') {
            const from = (t.fromAccountType || fallback) === id ? fallback : (t.fromAccountType || fallback);
            const to = (t.toAccountType || fallback) === id ? fallback : (t.toAccountType || fallback);
            const acct = (t.accountType || fallback) === id ? fallback : (t.accountType || fallback);
            return { ...t, fromAccountType: from, toAccountType: to, accountType: acct };
          }

          const tid = (t.accountType || fallback);
          return (tid === id) ? { ...t, accountType: fallback } : t;
        });

        accountTypes = accountTypes.filter((x) => x.id !== id);
        if (accountFilter === id) accountFilter = 'all';

        saveTypes();
        saveTx();
        renderAccTypeEditor();
        render();
        toast('Jenis akun dihapus');
      });
    });
  }

  function addAccountType() {
    const name = ($('newAccTypeName').value || '').trim();
    if (!name) return toast('Nama jenis akun kosong');

    const base = slugifyLabel(name);
    const id = uniqId(base, (x) => accountTypes.some((t) => t.id === x));
    const emoji = ($('newAccTypeEmoji').value || '').trim() || 'üí≥';

    accountTypes.push({ id, label: name, emoji, opening: 0 });
    $('newAccTypeName').value = '';
    $('newAccTypeEmoji').value = '';
    saveTypes();
    renderAccTypeEditor();
    render();
    toast('Jenis akun ditambah');
  }

  function saveAccountTypesFromEditor() {
    const emojiInputs = Array.from($('accTypeList').querySelectorAll('input[data-id-emoji]'));
    const labelInputs = Array.from($('accTypeList').querySelectorAll('input[data-id-label]'));
    const openInputs = Array.from($('accTypeList').querySelectorAll('input[data-id-open]'));

    const next = accountTypes.map((t) => ({ ...t, emoji: (typeof t.emoji === 'string' ? t.emoji : ''), opening: Number(t.opening || 0) }));

    for (const inp of emojiInputs) {
      const id = inp.getAttribute('data-id-emoji');
      const v = (inp.value || '').trim();
      const item = next.find((x) => x.id === id);
      if (!item) continue;
      item.emoji = v;
    }

    for (const inp of labelInputs) {
      const id = inp.getAttribute('data-id-label');
      const v = (inp.value || '').trim();
      const item = next.find((x) => x.id === id);
      if (!item) continue;
      item.label = v || item.label;
    }

    for (const inp of openInputs) {
      const id = inp.getAttribute('data-id-open');
      const n = Number(inp.value);
      const item = next.find((x) => x.id === id);
      if (!item) continue;
      item.opening = Number.isFinite(n) ? Math.max(0, n) : 0;
    }

    accountTypes = next;
    saveTypes();
    closeAccTypeModal();
    render();
    toast('Tersimpan');
  }

  // ===== Manage Categories Modal =====
  function openCatModal() {
    $('catMask').classList.add('show');
    $('catModal').classList.add('show');
    $('catModal').setAttribute('aria-hidden', 'false');
    renderCatEditor();
  }
  function closeCatModal() {
    $('catMask').classList.remove('show');
    $('catModal').classList.remove('show');
    $('catModal').setAttribute('aria-hidden', 'true');
    $('newCatName').value = '';
    $('newCatEmoji').value = '';
  }

  function renderCatEditor() {
    const list = $('catList');
    list.innerHTML = '';

    for (const c of categories) {
      const row = document.createElement('div');
      row.className = 'accTypeRow';
      row.innerHTML = `
        <div class="accTypeMeta">ID: ${escapeHtml(c.id)}</div>
        <input class="emojiIn" type="text" maxlength="4" value="${escapeHtml(c.emoji || '')}" data-id-emoji="${escapeHtml(c.id)}" placeholder="üè∑Ô∏è" />
        <input type="text" value="${escapeHtml(c.label)}" data-id="${escapeHtml(c.id)}" />
        <button class="iconMini" type="button" data-del="${escapeHtml(c.id)}" title="Hapus">üóë</button>
      `;
      list.appendChild(row);
    }

    list.querySelectorAll('button[data-del]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-del');
        if (categories.length <= 1) return toast('Minimal 1 kategori');

        if (btn.dataset.stage !== 'confirm') {
          list.querySelectorAll('button[data-del]').forEach((b) => {
            b.dataset.stage = '';
            b.textContent = 'üóë';
          });

          btn.dataset.stage = 'confirm';
          btn.textContent = 'Hapus?';
          toast('Klik sekali lagi untuk hapus');

          clearTimeout(window.__delCatTimer);
          window.__delCatTimer = setTimeout(() => {
            btn.dataset.stage = '';
            btn.textContent = 'üóë';
          }, 1400);
          return;
        }

        const fallback = categories.find((x) => x.id !== id)?.id;
        if (!fallback) return;

        tx = tx.map((t) => {
          const cid = t.categoryId || fallback;
          return (cid === id) ? { ...t, categoryId: fallback } : t;
        });

        categories = categories.filter((x) => x.id !== id);
        saveCats();
        saveTx();
        renderCatEditor();
        render();
        toast('Kategori dihapus');
      });
    });
  }

  function addCategory() {
    const name = ($('newCatName').value || '').trim();
    if (!name) return toast('Nama kategori kosong');

    const base = slugifyLabel(name);
    const id = uniqId(base, (x) => categories.some((c) => c.id === x));
    const emoji = ($('newCatEmoji').value || '').trim() || 'üè∑Ô∏è';

    categories.push({ id, label: name, emoji });
    $('newCatName').value = '';
    $('newCatEmoji').value = '';
    saveCats();
    renderCatEditor();
    render();
    toast('Kategori ditambah');
  }

  function saveCatsFromEditor() {
    const emojiInputs = Array.from($('catList').querySelectorAll('input[data-id-emoji]'));
    const inputs = Array.from($('catList').querySelectorAll('input[data-id]'));
    const next = categories.map((c) => ({ ...c, emoji: (typeof c.emoji === 'string' ? c.emoji : '') }));

    for (const inp of emojiInputs) {
      const id = inp.getAttribute('data-id-emoji');
      const v = (inp.value || '').trim();
      const item = next.find((x) => x.id === id);
      if (!item) continue;
      item.emoji = v;
    }

    for (const inp of inputs) {
      const id = inp.getAttribute('data-id');
      const v = (inp.value || '').trim();
      const item = next.find((x) => x.id === id);
      if (!item) continue;
      item.label = v || item.label;
    }

    categories = next;
    saveCats();
    closeCatModal();
    render();
    toast('Tersimpan');
  }

  // ===== Events =====
  function openTxModal(){
    $('txMask').classList.add('show');
    $('txModal').classList.add('show');
    $('txModal').setAttribute('aria-hidden','false');

    $('accTypeMask').classList.remove('show');
    $('accTypeModal').classList.remove('show');
    $('catMask').classList.remove('show');
    $('catModal').classList.remove('show');

    $('date').value = $('date').value || todayISO();
    $('type').value = $('type').value || 'income';

    $('type').dispatchEvent(new Event('change'));

    // Fokus ke input nominal (lebih stabil di mobile)
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        const el = $('amount');
        if (!el) return;
        try { el.focus({ preventScroll: true }); }
        catch { try { el.focus(); } catch {} }
        try { el.scrollIntoView({ block: 'center' }); } catch {}
      });
    });
  }
  function closeTxModal(){
    $('txMask').classList.remove('show');
    $('txModal').classList.remove('show');
    $('txModal').setAttribute('aria-hidden','true');
    clearEditMode();
  }

  $('openAddTab').addEventListener('click', () => {
    clearEditMode();
    resetTxForm();
    openTxModal();
  });
  $('txMask').addEventListener('click', closeTxModal);
  $('closeTxModal').addEventListener('click', closeTxModal);
  $('cancelTxBtn').addEventListener('click', closeTxModal);

  $('addBtn').addEventListener('click', addTx);
  $('search').addEventListener('input', render);
  $('month').addEventListener('change', render);
  $('seedBtn').addEventListener('click', seed);
  $('resetBtn').addEventListener('click', openResetConfirm);
  $('exportBtn').addEventListener('click', exportCSV);

  // detail modal events
  $('txDetailMask').addEventListener('click', closeTxDetail);
  $('closeTxDetail').addEventListener('click', closeTxDetail);
  $('txDetailCloseBtn').addEventListener('click', closeTxDetail);
  $('txDetailEditBtn').addEventListener('click', () => {
    if (!detailTxId) return;
    const id = detailTxId;
    closeTxDetail();
    startEditTx(id);
  });
  $('txDetailDeleteBtn').addEventListener('click', () => {
    if (!detailTxId) return;
    const btn = $('txDetailDeleteBtn');
    if (btn.dataset.stage !== 'confirm') {
      btn.dataset.stage = 'confirm';
      btn.textContent = 'Hapus? Klik sekali lagi';
      toast('Klik sekali lagi untuk hapus');
      clearTimeout(window.__delTxTimer);
      window.__delTxTimer = setTimeout(() => {
        btn.dataset.stage = '';
        btn.textContent = 'Hapus transaksi';
      }, 1400);
      return;
    }
    const id = detailTxId;
    closeTxDetail();
    deleteTxById(id);
  });

  // reset confirm events
  $('resetMask').addEventListener('click', closeResetConfirm);
  $('closeResetModal').addEventListener('click', closeResetConfirm);
  $('cancelResetBtn').addEventListener('click', closeResetConfirm);
  $('confirmResetBtn').addEventListener('click', () => {
    closeResetConfirm();
    resetAll();
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeResetConfirm();
      closeTxDetail();
      closeTxModal();
    }
  });

  $('type').addEventListener('change', () => {
    const v = $('type').value;

    const catField = $('categoryField');
    const catSel = $('category');

    if (v === 'transfer') {
      $('modeText').textContent = 'Mode: Transfer';
      $('modeDot').classList.remove('exp');
      $('modeDot').classList.add('trf');

      $('singleAcctField').classList.add('hidden');
      $('transferFromField').classList.remove('hidden');
      $('transferToField').classList.remove('hidden');

      if (catSel.value) lastNonTransferCategoryId = catSel.value;

      const transferCatId = ensureCategory('Transfer');
      catSel.value = transferCatId;
      catSel.disabled = true;
      if (catField) catField.classList.add('hidden');

      $('transferFrom').value = $('transferFrom').value || (accountTypes[0]?.id || 'cash');
      $('transferTo').value = $('transferTo').value || (accountTypes[1]?.id || accountTypes[0]?.id || 'cash');
      return;
    }

    const isIncome = v === 'income';
    $('modeText').textContent = `Mode: ${isIncome ? 'Pemasukan' : 'Pengeluaran'}`;

    $('modeDot').classList.remove('trf');
    $('modeDot').classList.toggle('exp', !isIncome);

    $('singleAcctField').classList.remove('hidden');
    $('transferFromField').classList.add('hidden');
    $('transferToField').classList.add('hidden');

    if (catField) catField.classList.remove('hidden');
    catSel.disabled = false;

    const transferId = categories.find((c) => (c.label || '').toLowerCase() === 'transfer')?.id;
    if (catSel.value === transferId) {
      catSel.value = lastNonTransferCategoryId || '';
    }
  });

  $('manageAccTypesBtn').addEventListener('click', openAccTypeModal);
  $('accTypeMask').addEventListener('click', closeAccTypeModal);
  $('closeAccTypeModal').addEventListener('click', closeAccTypeModal);
  $('cancelAccTypeBtn').addEventListener('click', closeAccTypeModal);
  $('addAccTypeBtn').addEventListener('click', addAccountType);
  $('saveAccTypeBtn').addEventListener('click', saveAccountTypesFromEditor);

  $('manageCatsTopBtn').addEventListener('click', openCatModal);
  $('catMask').addEventListener('click', closeCatModal);
  $('closeCatModal').addEventListener('click', closeCatModal);
  $('cancelCatBtn').addEventListener('click', closeCatModal);
  $('addCatBtn').addEventListener('click', addCategory);
  $('saveCatBtn').addEventListener('click', saveCatsFromEditor);

  // ===== Init =====
  $('date').value = todayISO();
  $('modeText').textContent = 'Mode: Pemasukan';
  $('modeDot').classList.remove('exp');
  render();

  // Floating Add (tetap 1 tombol, berubah posisi saat scroll)
  (function setupAddFab(){
    const btn = $('openAddTab');
    const slot = $('addBtnSlot');
    if (!btn || !slot) return;

    let normalHeight = btn.getBoundingClientRect().height || 56;

    const recalc = () => {
      const wasFab = btn.classList.contains('fab');
      if (wasFab) btn.classList.remove('fab');
      normalHeight = btn.getBoundingClientRect().height || normalHeight;
      if (wasFab) btn.classList.add('fab');
      if (wasFab) slot.style.height = normalHeight + 'px';
    };

    const apply = (isFab) => {
      btn.classList.toggle('fab', !!isFab);
      slot.style.height = isFab ? (normalHeight + 'px') : '';
    };

    // default
    apply(false);

    if ('IntersectionObserver' in window) {
      const obs = new IntersectionObserver((entries) => {
        const e = entries[0];
        const visible = e.isIntersecting && e.intersectionRatio > 0.6;
        apply(!visible);
      }, { threshold: [0, 0.35, 0.6, 1] });

      obs.observe(slot);
    } else {
      window.addEventListener('scroll', () => {
        const r = slot.getBoundingClientRect();
        const visible = r.top >= 0 && r.bottom <= (window.innerHeight || document.documentElement.clientHeight);
        apply(!visible);
      }, { passive: true });
    }

    window.addEventListener('resize', recalc, { passive: true });
    setTimeout(recalc, 60);
  })();

  // ===== Self-tests (ringan) =====
  (function selfTest(){
    try{
      console.assert(csvEscape('a,b') === '"a,b"', 'csvEscape comma');
      console.assert(csvEscape('a"b') === '"a""b"', 'csvEscape quote');
      console.assert(csvEscape('a
b') === '"a
b"', 'csvEscape newline');

      const sample = [['A','B'],['1','2']];
      const csv = 'Ôªø' + sample.map(r => r.map(csvEscape).join(',')).join('
');
      console.assert(csv.includes('
'), 'csv join newline');

      console.assert(typeof render === 'function', 'render exists');
      render();

      const transferId = ensureCategory('Transfer');
      console.assert(!!transferId, 'ensureCategory transfer');

      console.assert(typeof acctLabel('cash') === 'string', 'acctLabel string');
      console.assert(typeof catLabel(transferId) === 'string', 'catLabel string');
    }catch(e){
      console.warn('Self-test failed', e);
    }
 
